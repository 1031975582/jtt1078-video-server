<html>
	<head>
		<title>Chunked Audio Test</title>
	</head>
	<body>
	</body>
</html>
<script src="//static.transnova.com.cn//assets/global/plugins/jquery.min.js" type="text/javascript"></script>
<script type="text/javascript">

	var streamOffset = 0;

	window.AudioContext = window.AudioContext || window.webkitAudioContext || window.mozAudioContext || window.msAudioContext;
	var audioContext = new AudioContext();
	var segments = [];
	var ended = true;

    function playNextSegment()
	{
        if (segments.length > 0 && ended)
        {
            ended = false;
            var audioBufferSouceNode = audioContext.createBufferSource();
            audioBufferSouceNode.onended = function()
            {
                // playNextSegment();
                ended = true;
                console.log('play ended...');
            }
            audioBufferSouceNode.buffer = segments.shift();
            audioBufferSouceNode.connect(audioContext.destination);
            audioBufferSouceNode.start(0);
        }
	}

	$(document).ready(function()
	{
	    var xhr = new XMLHttpRequest();
	    xhr.open('GET', '/audio/1111111111111111', true);
        xhr.onprogress = function()
        {
            var textBuffer = xhr.responseText;
            var arrayBuffer = textToArrayBuffer(textBuffer, streamOffset);
            streamOffset += arrayBuffer.byteLength;

			audioContext.decodeAudioData(arrayBuffer, function(buffer)
			{
                segments.push(buffer);
            });
        }
        xhr.send();
        setInterval(playNextSegment, 50);
	});

	function textToArrayBuffer(textBuffer, startOffset)
	{
	    var len = textBuffer.length - startOffset;
		var arrayBuffer = new ArrayBuffer(len);
		var ui8a = new Uint8Array(arrayBuffer, 0);
        var hex = [];
		for (var i = 0, j = startOffset; i < len; i++, j++)
		{
		    ui8a[i] = (textBuffer.charCodeAt(j) & 0xff);

            var ch = (ui8a[i] & 0xff).toString(16);
            hex.push(ch.length == 1 ? '0' + ch : ch);
            hex.push(' ');
            if (i % 4 == 3) hex.push("   ");
            if (i % 16 == 15) hex.push("\n");
		}
		console.log(hex.join(''));

		return arrayBuffer;
	}

</script>
